{% extends "base.html" %}

{% block title %}Music Library - Albums{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>
            <i class="fas fa-record-vinyl"></i> Music Library
        </h1>
        <p class="lead">Complete album collection with metadata and match status</p>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="GET" class="d-flex">
            <input type="text" name="search" class="form-control me-2" 
                   placeholder="Search albums or artists..." 
                   value="{{ search }}" id="searchInput">
            <input type="hidden" name="filter" value="{{ filter_matched }}">
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <button type="submit" class="btn btn-outline-primary">
                <i class="fas fa-search"></i>
            </button>
        </form>
    </div>
    <div class="col-md-6">
        <div class="btn-group me-2" role="group">
            <a href="?search={{ search }}&filter=all&sort={{ sort_by }}&per_page={{ per_page }}" 
               class="btn btn-sm {{ 'btn-primary' if filter_matched == 'all' else 'btn-outline-secondary' }}">
                All Albums
            </a>
            <a href="?search={{ search }}&filter=never&sort={{ sort_by }}&per_page={{ per_page }}" 
               class="btn btn-sm {{ 'btn-primary' if filter_matched == 'never' else 'btn-outline-secondary' }}">
                Never Matched
            </a>
            <a href="?search={{ search }}&filter=matched&sort={{ sort_by }}&per_page={{ per_page }}" 
               class="btn btn-sm {{ 'btn-primary' if filter_matched == 'matched' else 'btn-outline-secondary' }}">
                Matched
            </a>
            <a href="?search={{ search }}&filter=review&sort={{ sort_by }}&per_page={{ per_page }}" 
               class="btn btn-sm {{ 'btn-primary' if filter_matched == 'review' else 'btn-outline-secondary' }}">
                Needs Review
            </a>
            <a href="?search={{ search }}&filter=errors&sort={{ sort_by }}&per_page={{ per_page }}" 
               class="btn btn-sm {{ 'btn-primary' if filter_matched == 'errors' else 'btn-outline-secondary' }}">
                <i class="fas fa-exclamation-triangle"></i> Scan Errors
            </a>
            <a href="?search={{ search }}&filter=no_artwork&sort={{ sort_by }}&per_page={{ per_page }}" 
               class="btn btn-sm {{ 'btn-primary' if filter_matched == 'no_artwork' else 'btn-outline-secondary' }}">
                <i class="fas fa-image"></i> No Artwork
            </a>
        </div>
        
        <!-- Sort Dropdown -->
        <div class="dropdown d-inline">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                    data-bs-toggle="dropdown">
                <i class="fas fa-sort"></i> Sort
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?search={{ search }}&filter={{ filter_matched }}&sort=artist&per_page={{ per_page }}">Artist</a></li>
                <li><a class="dropdown-item" href="?search={{ search }}&filter={{ filter_matched }}&sort=album&per_page={{ per_page }}">Album</a></li>
                <li><a class="dropdown-item" href="?search={{ search }}&filter={{ filter_matched }}&sort=year&per_page={{ per_page }}">Year</a></li>
                <li><a class="dropdown-item" href="?search={{ search }}&filter={{ filter_matched }}&sort=last_scanned&per_page={{ per_page }}">Last Scanned</a></li>
                <li><a class="dropdown-item" href="?search={{ search }}&filter={{ filter_matched }}&sort=last_matched&per_page={{ per_page }}">Last Matched</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Progress Indicator (hidden by default) -->
<div id="progress-container" class="row mb-3" style="display: none;">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-sync fa-spin text-info me-2"></i>
                        <span id="progress-text">Scanning library...</span>
                    </div>
                    <div class="flex-fill mx-3">
                        <div class="progress" style="height: 8px;">
                            <div id="progress-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <span id="progress-stats" class="text-muted">0/0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                <div>Showing {{ albums|length }} of {{ total }} albums 
                {% if search %}(filtered by "{{ search }}"){% endif %}</div>
                {% if total_pages > 1 %}
                <small>Page {{ page }} of {{ total_pages }}</small>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                <label for="per-page-select" class="text-muted me-2" style="font-size: 0.9em;">Per page:</label>
                <select id="per-page-select" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                    <option value="10" {{ 'selected' if per_page == 10 }}>10</option>
                    <option value="25" {{ 'selected' if per_page == 25 }}>25</option>
                    <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
                    <option value="75" {{ 'selected' if per_page == 75 }}>75</option>
                    <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
                    <option value="200" {{ 'selected' if per_page == 200 }}>200</option>
                </select>
            </div>
            <div class="btn-group">
                <a href="/api/scan-library" class="btn btn-sm btn-success" id="scanButton">
                    <i class="fas fa-sync"></i> Rescan Library
                </a>
                {% if filter_matched == 'errors' %}
                <a href="/api/rescan-errors" class="btn btn-sm btn-warning" id="rescanErrorsButton">
                    <i class="fas fa-tools"></i> Fix Scan Errors
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Albums Grid -->
{% if albums %}
<div class="albums-grid">
    {% for album in albums %}
    <div class="album-card">
        <!-- Album Artwork -->
        <div class="album-artwork" onclick="showFullscreenArtwork({{ album.id }}, '{{ album.artist }}', '{{ album.album }}')" style="cursor: pointer;">
            <img src="/api/artwork/{{ album.id }}" alt="Album artwork" 
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                 class="artwork-image">
            <div class="artwork-fallback" style="display: none; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute;">
                <i class="fas fa-record-vinyl fa-3x text-muted"></i>
            </div>
        </div>
        
        <!-- Album Info -->
        <div class="album-info">
            {% if album.scan_error %}
                <div class="album-artist text-warning">
                    <i class="fas fa-exclamation-triangle"></i> Scan Error
                </div>
                <div class="album-title" title="{{ album.file_path }}">
                    {{ album.file_path.split('/')[-1] if album.file_path else 'Unknown Directory' }}
                </div>
            {% else %}
                <div class="album-artist">{{ album.artist }}</div>
                <div class="album-title">{{ album.album }}</div>
            {% endif %}
            
            <!-- Metadata Row -->
            <div class="album-meta">
                <span class="track-count">
                    <i class="fas fa-music"></i> {{ album.track_count }} tracks
                </span>
                {% if album.year %}
                <span class="album-year">{{ album.year }}</span>
                {% endif %}
            </div>
            
            <!-- Genre Tags -->
            {% if album.genre %}
            <div class="genre-tags">
                {% for genre in album.genre.split(';') %}
                <span class="genre-tag">{{ genre.strip() }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Match Status Badge -->
            <div class="match-status">
                <span class="badge bg-{{ album.match_status.class }}" {% if album.scan_error %}title="{{ album.scan_error }}"{% endif %}>
                    {% if album.match_status.type == 'error' %}
                        <i class="fas fa-exclamation-triangle"></i>
                    {% elif album.match_status.type == 'never' %}
                        <i class="fas fa-times"></i>
                    {% elif album.match_status.type == 'matched' %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        <i class="fas fa-exclamation"></i>
                    {% endif %}
                    {{ album.match_status.text }}
                </span>
            </div>
        </div>
        
        <!-- Overlay for clicking -->
        {% if album.batch_status == 'needs_review' %}
        <a href="/albums/{{ album.id }}/review" class="album-overlay review-overlay" title="Click to review metadata changes"></a>
        {% else %}
        <a href="/albums/{{ album.id }}" class="album-overlay"></a>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Albums pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page - 1 }}&search={{ search }}&filter={{ filter_matched }}&sort={{ sort_by }}&per_page={{ per_page }}">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        </li>
        {% endif %}
        
        {% set start_page = [1, page - 2]|max %}
        {% set end_page = [total_pages, page + 2]|min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page=1&search={{ search }}&filter={{ filter_matched }}&sort={{ sort_by }}&per_page={{ per_page }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {{ 'active' if p == page else '' }}">
            <a class="page-link" href="?page={{ p }}&search={{ search }}&filter={{ filter_matched }}&sort={{ sort_by }}&per_page={{ per_page }}">{{ p }}</a>
        </li>
        {% endfor %}
        
        {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="?page={{ total_pages }}&search={{ search }}&filter={{ filter_matched }}&sort={{ sort_by }}&per_page={{ per_page }}">{{ total_pages }}</a>
        </li>
        {% endif %}
        
        {% if has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page + 1 }}&search={{ search }}&filter={{ filter_matched }}&sort={{ sort_by }}&per_page={{ per_page }}">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="fas fa-record-vinyl fa-5x text-muted mb-4"></i>
    <h3>No Albums Found</h3>
    <p class="text-muted">
        {% if search %}
            No albums match your search "{{ search }}".
        {% else %}
            Your music library appears to be empty. 
        {% endif %}
    </p>
    <a href="/api/scan-library" class="btn btn-primary">
        <i class="fas fa-sync"></i> Scan Music Library
    </a>
</div>
{% endif %}

<!-- Fullscreen Artwork Modal -->
<div id="fullscreen-artwork-modal" onclick="closeFullscreenArtwork()">
    <span class="close-button" onclick="closeFullscreenArtwork()">&times;</span>
    <img id="fullscreen-artwork" alt="Album artwork" onclick="event.stopPropagation(); toggleFullscreen();">
    <div id="artwork-info">
        <div id="artwork-title"></div>
        <div id="artwork-artist"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* Albums Grid Styles */
.albums-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.album-card {
    background: #2c2c2c;
    border-radius: 12px;
    padding: 20px;
    position: relative;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    overflow: hidden;
}

.album-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    border-color: #007bff;
}

/* Special styling for albums that need review */
.album-card:has(.review-overlay) {
    border-color: #ffc107;
    box-shadow: 0 0 15px rgba(255, 193, 7, 0.2);
}

.album-card:has(.review-overlay):hover {
    border-color: #ffc107;
    box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
}

.review-overlay:after {
    content: "📝 Review";
    position: absolute;
    top: 10px;
    right: 10px;
    background: #ffc107;
    color: #000;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7em;
    font-weight: bold;
    z-index: 10;
}

.album-artwork {
    text-align: center;
    margin-bottom: 15px;
    padding: 20px;
    background: #1a1a1a;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.artwork-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
    transition: transform 0.3s ease;
}

.album-card:hover .artwork-image {
    transform: scale(1.05);
}

/* Fullscreen artwork modal */
#fullscreen-artwork-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#fullscreen-artwork-modal.show {
    display: flex;
}

#fullscreen-artwork {
    max-width: 90vw;
    max-height: 80vh;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

#artwork-info {
    color: white;
    text-align: center;
    margin-top: 20px;
    font-size: 1.2em;
}

.close-button {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    cursor: pointer;
    transition: color 0.3s;
}

.close-button:hover {
    color: #ccc;
}

.album-info {
    text-align: center;
}

.album-artist {
    font-weight: bold;
    font-size: 1.1em;
    color: #fff;
    margin-bottom: 5px;
    line-height: 1.2;
}

.album-title {
    color: #ccc;
    font-size: 0.95em;
    margin-bottom: 10px;
    line-height: 1.3;
}

.album-meta {
    font-size: 0.8em;
    color: #888;
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    gap: 15px;
}

.genre-tags {
    margin-bottom: 10px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 5px;
}

.genre-tag {
    background: #444;
    color: #ccc;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
}

.match-status {
    margin-top: 15px;
}

.album-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10;
    text-decoration: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .albums-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .album-card {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .albums-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}
</style>

<script>
// Scan library button handling
document.getElementById('scanButton').addEventListener('click', function(e) {
    e.preventDefault();
    
    const button = this;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting scan...';
    
    // Start the scan
    fetch('/api/scan-library')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Start monitoring progress
                monitorScanProgress(button, originalText);
            } else {
                alert('Scan failed: ' + data.error);
                button.disabled = false;
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            alert('Scan failed: ' + error.message);
            button.disabled = false;
            button.innerHTML = originalText;
        });
});

// Monitor scan progress
function monitorScanProgress(button, originalText) {
    // Show progress container
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressStats = document.getElementById('progress-stats');
    
    progressContainer.style.display = 'block';
    
    const progressInterval = setInterval(() => {
        fetch('/api/live-progress')
            .then(response => response.json())
            .then(data => {
                if (data.has_active_jobs) {
                    const job = data.running_jobs[0];
                    if (job) {
                        const processed = job.processed || 0;
                        const total = job.total_albums || 0;
                        const percentage = total > 0 ? Math.round((processed / total) * 100) : 0;
                        
                        // Update button
                        button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Scanning... ${percentage}%`;
                        
                        // Update progress bar
                        progressBar.style.width = percentage + '%';
                        progressText.textContent = `Scanning library... Processing albums`;
                        progressStats.textContent = `${processed}/${total}`;
                    }
                } else {
                    // Scan completed
                    clearInterval(progressInterval);
                    
                    // Update to completion state
                    progressBar.style.width = '100%';
                    progressBar.classList.remove('bg-info');
                    progressBar.classList.add('bg-success');
                    progressText.innerHTML = '<i class="fas fa-check text-success me-2"></i>Scan complete!';
                    button.innerHTML = '<i class="fas fa-check"></i> Scan Complete!';
                    
                    // Hide progress and reload after delay
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        window.location.reload();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Progress check failed:', error);
                // Continue checking, might be temporary network issue
            });
    }, 1000); // Check progress every second
    
    // Failsafe: stop monitoring after 10 minutes
    setTimeout(() => {
        clearInterval(progressInterval);
        progressContainer.style.display = 'none';
        button.disabled = false;
        button.innerHTML = originalText;
    }, 600000);
}

// Re-scan errors button handling
const rescanErrorsButton = document.getElementById('rescanErrorsButton');
if (rescanErrorsButton) {
    rescanErrorsButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        const button = this;
        const originalText = button.innerHTML;
        
        if (!confirm('This will attempt to fix albums with scan errors using improved extraction. Continue?')) {
            return;
        }
        
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting error fix...';
        
        fetch('/api/rescan-errors')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Start monitoring progress
                    monitorScanProgress(button, originalText);
                } else {
                    alert('Re-scan failed: ' + data.error);
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            })
            .catch(error => {
                alert('Re-scan failed: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalText;
            });
    });
}

// Fullscreen artwork functionality
function showFullscreenArtwork(albumId, artist, album) {
    const modal = document.getElementById('fullscreen-artwork-modal');
    const artwork = document.getElementById('fullscreen-artwork');
    const title = document.getElementById('artwork-title');
    const artistDiv = document.getElementById('artwork-artist');
    
    // Set artwork source and info
    artwork.src = `/api/artwork/${albumId}`;
    title.textContent = album;
    artistDiv.textContent = artist;
    
    // Show modal
    modal.classList.add('show');
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
}

function closeFullscreenArtwork() {
    const modal = document.getElementById('fullscreen-artwork-modal');
    modal.classList.remove('show');
    
    // Restore body scrolling
    document.body.style.overflow = '';
    
    // Exit fullscreen if active
    if (document.fullscreenElement || document.webkitFullscreenElement || 
        document.mozFullScreenElement || document.msFullscreenElement) {
        exitFullscreen();
    }
}

function toggleFullscreen() {
    const artwork = document.getElementById('fullscreen-artwork');
    
    if (!document.fullscreenElement && !document.webkitFullscreenElement && 
        !document.mozFullScreenElement && !document.msFullscreenElement) {
        // Enter fullscreen
        if (artwork.requestFullscreen) {
            artwork.requestFullscreen();
        } else if (artwork.webkitRequestFullscreen) {
            artwork.webkitRequestFullscreen();
        } else if (artwork.mozRequestFullScreen) {
            artwork.mozRequestFullScreen();
        } else if (artwork.msRequestFullscreen) {
            artwork.msRequestFullscreen();
        }
    } else {
        // Exit fullscreen
        exitFullscreen();
    }
}

function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
}

// Handle escape key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFullscreenArtwork();
    }
});

// Real-time search
const searchInput = document.getElementById('searchInput');
let searchTimeout;
let wasSearching = false;

searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    wasSearching = true;
    searchTimeout = setTimeout(() => {
        // Store that we're about to submit for search
        sessionStorage.setItem('searchSubmitted', 'true');
        this.form.submit();
    }, 800);
});

// Restore focus after page load if we just searched
document.addEventListener('DOMContentLoaded', function() {
    if (sessionStorage.getItem('searchSubmitted') === 'true') {
        sessionStorage.removeItem('searchSubmitted');
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
            searchInput.focus();
            // Move cursor to end of input
            searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        }, 100);
    }
    
    // Check for active jobs on page load
    checkForActiveJobs();
});

// Check for active jobs and show progress if any
function checkForActiveJobs() {
    fetch('/api/live-progress')
        .then(response => response.json())
        .then(data => {
            if (data.has_active_jobs) {
                // There's an active scan, start monitoring
                const scanButton = document.getElementById('scanButton');
                if (scanButton) {
                    scanButton.disabled = true;
                    scanButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                    monitorScanProgress(scanButton, scanButton.dataset.originalText || '<i class="fas fa-sync"></i> Rescan Library');
                }
            }
        })
        .catch(error => {
            console.error('Failed to check for active jobs:', error);
        });
}

// Page size change
function changePageSize(newPerPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', newPerPage);
    url.searchParams.set('page', '1'); // Reset to page 1 when changing page size
    window.location.href = url.toString();
}
</script>
{% endblock %}